#!/bin/bash

# Vibecode Helper - Comandos rápidos para servidor Vibecode
# Uso: ./vibe [comando]

set -e

SSH_HOST="019b3c58-3269-7708-b5ff-6eb362d545a7.vibecodeapp.io"
SSH_PORT="2222"
SSH_USER="vibecode"
SSH_PASS="unwanted-owl-seminar-profusely-nimble"
REMOTE_PATH="/home/user/workspace/mobile"

# Cores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

ssh_exec() {
    sshpass -p "$SSH_PASS" ssh -p $SSH_PORT -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} "$1"
}

show_help() {
    echo -e "${BLUE}Vibecode Helper - Comandos Rápidos${NC}"
    echo ""
    echo "Uso: ./vibe [comando]"
    echo ""
    echo "Comandos disponíveis:"
    echo "  connect          - Conectar ao servidor SSH"
    echo "  logs             - Ver logs do Expo em tempo real"
    echo "  status           - Ver status dos processos"
    echo "  install          - Instalar dependências (bun install)"
    echo "  restart          - Reiniciar servidor Expo"
    echo "  clear-cache      - Limpar cache do Metro e Expo"
    echo "  sync             - Sincronizar código (local → servidor)"
    echo "  sync-back        - Sincronizar código (servidor → local)"
    echo "  env              - Ver variáveis de ambiente"
    echo "  run [comando]    - Executar comando customizado"
    echo ""
    echo "Exemplos:"
    echo "  ./vibe logs"
    echo "  ./vibe install"
    echo "  ./vibe run 'ls -la'"
    echo ""
}

case "$1" in
    connect)
        echo -e "${BLUE}Conectando ao servidor Vibecode...${NC}"
        sshpass -p "$SSH_PASS" ssh -p $SSH_PORT ${SSH_USER}@${SSH_HOST}
        ;;
    
    logs)
        echo -e "${BLUE}Mostrando logs do Expo (Ctrl+C para sair)...${NC}"
        ssh_exec "tail -f ${REMOTE_PATH}/expo.log"
        ;;
    
    status)
        echo -e "${BLUE}Status dos processos:${NC}"
        ssh_exec "ps aux | grep -E '(expo|node|metro)' | grep -v grep"
        ;;
    
    install)
        echo -e "${BLUE}Instalando dependências...${NC}"
        ssh_exec "cd ${REMOTE_PATH} && bun install"
        echo -e "${GREEN}✓ Dependências instaladas!${NC}"
        ;;
    
    restart)
        echo -e "${YELLOW}Reiniciando servidor Expo...${NC}"
        ssh_exec "sv restart expo"
        echo -e "${GREEN}✓ Servidor reiniciado!${NC}"
        ;;
    
    clear-cache)
        echo -e "${YELLOW}Limpando cache...${NC}"
        ssh_exec "cd ${REMOTE_PATH} && rm -rf .expo .metro-cache"
        echo -e "${GREEN}✓ Cache limpo!${NC}"
        echo -e "${BLUE}ℹ Reinicie o servidor: ./vibe restart${NC}"
        ;;
    
    sync)
        echo -e "${BLUE}Sincronizando código (local → servidor)...${NC}"
        ./sync-to-server.sh
        ;;
    
    sync-back)
        echo -e "${YELLOW}Sincronizando código (servidor → local)...${NC}"
        ./sync-from-server.sh
        ;;
    
    env)
        echo -e "${BLUE}Variáveis de ambiente:${NC}"
        ssh_exec "cd ${REMOTE_PATH} && cat .env"
        ;;
    
    run)
        if [ -z "$2" ]; then
            echo -e "${YELLOW}Uso: ./vibe run '[comando]'${NC}"
            exit 1
        fi
        echo -e "${BLUE}Executando: $2${NC}"
        ssh_exec "cd ${REMOTE_PATH} && $2"
        ;;
    
    help|--help|-h|"")
        show_help
        ;;
    
    *)
        echo -e "${YELLOW}Comando desconhecido: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
